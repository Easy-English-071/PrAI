<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PrAI - Luyện Phát Âm với AI</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23007CF0;'/%3E%3Cstop offset='100%25' style='stop-color:%2300DFD8;'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ctext x='50' y='55' font-family='Exo 2, sans-serif' font-size='40' font-weight='700' fill='white' text-anchor='middle' dominant-baseline='middle'%3EPrAI%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans:wght@400;700&family=Exo+2:wght@700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg-color: #f8fafc; --bg-blob-1: #0ea5e9; --bg-blob-2: #14b8a6;
      --glass-bg: rgba(248, 250, 252, 0.6); --glass-border: rgba(255, 255, 255, 0.7);
      --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #007CF0;
      --accent-danger: #ef4444; --accent-success: #22c55e; --accent-warning: #f59e0b;
      --btn-primary-bg: #007CF0; --btn-primary-hover-bg: #0056b3; --btn-secondary-bg: rgba(241,245,249,0.7);
      --btn-secondary-hover-bg: rgba(226,232,240,0.9); --input-bg: rgba(255,255,255,0.4); --input-focus-bg: rgba(255,255,255,0.6);
      --shadow-color: rgba(100,116,139,0.2); --highlight-correct: rgba(34, 197, 94, 0.1); --highlight-approximate: rgba(245, 158, 11, 0.1); --highlight-incorrect: rgba(239, 68, 68, 0.1);
      --radius-sm: .75rem; --radius-md: 1rem; --radius-lg: 1.5rem;
    }
    [data-theme="dark"] {
      --bg-color: #020617; --bg-blob-1: #0369a1; --bg-blob-2: #0d9488; --glass-bg: rgba(30,41,59,0.5);
      --glass-border: rgba(255,255,255,0.1); --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --btn-primary-bg: #007CF0; --btn-primary-hover-bg: #0095ff; --btn-secondary-bg: rgba(51,65,85,0.5);
      --btn-secondary-hover-bg: rgba(51,65,85,0.8); --input-bg: rgba(15,23,42,0.5); --input-focus-bg: rgba(15,23,42,0.7);
      --shadow-color: rgba(0,0,0,0.35); --highlight-correct: rgba(74,222,128,0.15); --highlight-approximate: rgba(250,204,21,0.15); --highlight-incorrect: rgba(248,113,113,0.15);
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-primary); min-height: 100vh; }
    .background-container { position: fixed; inset: 0; z-index: -1; overflow: hidden; }
    .blob{position:absolute;border-radius:50%;filter:blur(120px);opacity:.4}
    .blob-1{width:450px;height:450px;background:var(--bg-blob-1);animation:move 20s infinite alternate}
    .blob-2{width:350px;height:350px;background:var(--bg-blob-2);animation:move 25s infinite alternate-reverse;-webkit-animation-delay:-5s;animation-delay:-5s}
    @keyframes move{from{transform:translate(-15vw,-15vh) scale(1)}to{transform:translate(65vw,75vh) scale(1.2)}}

    .font-logo{font-family:'Exo 2',sans-serif}
    #simple-ipa-text,#detailed-ipa-text,.phoneme,.ipa-text{font-family:'Noto Sans',sans-serif}
    .glass-card{background:var(--glass-bg);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);box-shadow:0 8px 32px 0 var(--shadow-color), inset 0 1px 0 0 var(--glass-border);border-radius:var(--radius-lg);border:1px solid var(--glass-border);transition:all .3s}
    .main-card{padding:clamp(1rem,5vw,2.5rem)} .card-layer{padding:1.5rem;border-radius:var(--radius-md)}
    .card-layer-inset{background:var(--input-bg);padding:1rem;border-radius:var(--radius-md);border:1px solid var(--glass-border);box-shadow:inset 0 2px 4px var(--shadow-color)}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1.5rem;border-radius:var(--radius-sm);font-weight:600;border:1px solid transparent;cursor:pointer;transition:.2s;box-shadow:0 4px 10px var(--shadow-color)}
    .btn:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 20px var(--shadow-color)}
    .btn:active:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 10px var(--shadow-color)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--btn-primary-bg);color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.2)}
    .btn-primary:hover:not(:disabled){background:var(--btn-primary-hover-bg)}
    .btn-secondary{background:var(--btn-secondary-bg);color:var(--text-secondary);border:1px solid var(--glass-border);backdrop-filter:blur(8px)}
    .btn-secondary:hover:not(:disabled){background:var(--btn-secondary-hover-bg);color:var(--text-primary)}
    .btn-icon{width:2.75rem;height:2.75rem;border-radius:50%;padding:0;display:inline-flex;align-items:center;justify-content:center}

    .btn-record{width:7rem;height:7rem;border-radius:50%;background:radial-gradient(circle,#ff5f5f 0%,#ef4444 100%);color:#fff;font-weight:600;border:3px solid rgba(255,255,255,.4)}
    .btn-record.is-recording{animation:pulse 1.5s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 color-mix(in srgb,var(--accent-danger) 70%, transparent)}70%{box-shadow:0 0 0 15px color-mix(in srgb,var(--accent-danger) 0%, transparent)}100%{box-shadow:0 0 0 0 color-mix(in srgb,var(--accent-danger) 0%, transparent)}}

    .input-field{width:100%;background:var(--input-bg);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:.75rem 1rem;color:var(--text-primary);transition:.2s;backdrop-filter:blur(5px)}
    .input-field:focus{outline:none;border-color:var(--accent-primary);background:var(--input-focus-bg);box-shadow:0 0 0 3px color-mix(in srgb,var(--accent-primary) 30%, transparent)}

    .phoneme{padding:.5rem .75rem;border-radius:.5rem;font-size:1.125rem;position:relative;transition:.2s;color:var(--text-secondary)}
    .phoneme.status-correct{background:var(--highlight-correct);color:var(--accent-success)}
    .phoneme.status-approximate{background:var(--highlight-approximate);color:var(--accent-warning)}
    .phoneme.status-incorrect{background:var(--highlight-incorrect);color:var(--accent-danger)}

    .analysis-box-detailed{background-color:color-mix(in srgb,var(--input-bg) 60%, transparent);border:1px solid var(--glass-border);border-radius:var(--radius-md);padding:1.25rem;box-shadow:inset 0 2px 4px color-mix(in srgb,var(--shadow-color) 50%, transparent)}
    .analysis-title{font-size:1.125rem;font-weight:600;color:var(--text-primary);margin-bottom:1rem}

    .intonation-chart-container{width:100%;height:200px;background:var(--input-bg);border-radius:var(--radius-sm);padding:.5rem;border:1px solid var(--glass-border);margin-bottom:1rem}
    .syllable-chart-container{width:100%;height:120px;background:var(--input-bg);border-radius:var(--radius-sm);padding:.5rem;border:1px solid var(--glass-border);margin-bottom:1rem}
    .syllable-bubble{display:inline-flex;align-items:center;justify-content:center;padding:.5rem .75rem;border-radius:9999px;border:1px solid var(--glass-border);margin-right:.5rem;font-weight:600}
    .syllable-bubble.stressed{outline:3px solid color-mix(in srgb,var(--accent-primary) 40%, transparent)}

    .tooltip{visibility:hidden;opacity:0;transition:.2s;transform:translate(-50%,10px);background:var(--bg-color);color:var(--text-primary);border:1px solid var(--glass-border);position:absolute;bottom:100%;left:50%;margin-bottom:.5rem;width:256px;border-radius:.75rem;padding:.75rem;font-size:.875rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}
    .has-tooltip:hover .tooltip{visibility:visible;opacity:1}

    .score-container{width:140px;height:140px;margin:1rem auto;display:flex;align-items:center;justify-content:center;transition:.5s;border-radius:50%;border:4px solid transparent;background:radial-gradient(circle,color-mix(in srgb,var(--accent-primary) 10%, transparent) 0%, rgba(74,128,240,0) 70%)}
    .score-container.score-high{border-color:var(--accent-success)}
    .score-container.score-medium{border-color:var(--accent-warning)}
    .score-container.score-low{border-color:var(--accent-danger)}
    #overall-score{font-size:3.5rem;font-weight:700}

    .fade-in{animation:fadeIn .6s ease-out forwards}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body class="antialiased">
  <div class="background-container">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
  </div>

  <div class="w-full max-w-3xl mx-auto p-4 relative z-10">
    <header class="text-center mb-8 fade-in relative flex justify-between items-center">
      <button id="history-btn" class="btn btn-secondary btn-icon" aria-label="Xem lịch sử">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
      </button>
      <div class="absolute left-1/2 -translate-x-1/2">
        <h1 class="text-5xl md:text-6xl font-bold font-logo" style="color: var(--accent-primary);">PrAI</h1>
        <p class="text-text-secondary text-sm md:text-base">Trợ lý luyện phát âm AI của bạn</p>
      </div>
      <button id="theme-toggle" class="btn btn-secondary btn-icon" aria-label="Toggle theme">
        <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
        <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
      </button>
    </header>

    <main class="main-card glass-card space-y-8">
      <section class="input-section card-layer glass-card space-y-4">
        <div>
          <label for="text-input" class="block text-lg font-semibold text-text-primary mb-3">Nhập văn bản cần luyện tập:</label>
          <textarea id="text-input" rows="3" maxlength="150" class="input-field" placeholder="Ví dụ: What are you doing?"></textarea>
          <div id="char-counter" class="text-right text-sm text-text-secondary mt-1">0 / 150</div>
          <div class="mt-4 flex flex-col sm:flex-row items-center gap-4">
            <div class="flex-grow w-full">
              <label for="accent-select" class="block text-sm font-medium text-text-secondary mb-1">Chọn giọng:</label>
              <select id="accent-select" class="input-field">
                <option value="British English" selected>Anh - Anh (BrE)</option>
                <option value="American English">Anh - Mỹ (AmE)</option>
              </select>
            </div>
            <div class="flex-shrink-0 flex gap-3 self-end">
              <button id="random-practice-btn" class="btn btn-secondary">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
                <span class="text hidden sm:inline">Ngẫu nhiên</span>
              </button>
              <button id="transcribe-btn" class="btn btn-primary relative">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                <span class="text">Phiên âm</span>
                <div class="btn-spinner hidden absolute inset-0 m-auto h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
              </button>
            </div>
          </div>
        </div>
      </section>

      <section id="controls-section" class="hidden space-y-6">
        <div class="card-layer glass-card space-y-4">
          <div class="flex items-center justify-between">
            <div class="min-w-0">
              <h3 class="font-semibold text-text-secondary text-md">Phiên âm cơ bản</h3>
              <p id="simple-ipa-text" class="text-lg text-text-primary tracking-wider"></p>
            </div>
            <div class="relative w-11 h-11">
              <button id="listen-clear-btn" class="btn-icon btn-secondary absolute inset-0" title="Nghe giọng rõ từng từ">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
              </button>
              <div id="listen-clear-loader" class="btn-icon btn-secondary absolute inset-0 hidden items-center justify-center">
                <div class="btn-spinner h-5 w-5 border-2 border-slate-400 border-t-transparent rounded-full"></div>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <div class="min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="font-semibold text-text-secondary text-md">Phiên âm & Cụm tư duy</h3>
                <div id="thought-group-info" class="has-tooltip relative hidden">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-text-secondary cursor-pointer"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                  <div id="thought-group-tooltip" class="tooltip absolute bottom-full left-1/2 mb-2 w-72 rounded-lg p-3 text-xs shadow-lg"></div>
                </div>
              </div>
              <div class="space-y-2">
                <p id="detailed-ipa-text" class="text-xl text-accent-primary tracking-wider"></p>
                <div id="thought-group-display" class="text-lg tracking-wide leading-relaxed font-medium"></div>
              </div>
            </div>
            <div class="relative w-11 h-11">
              <button id="listen-natural-btn" class="btn-icon btn-secondary absolute inset-0" title="Nghe giọng tự nhiên">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
              </button>
              <div id="listen-natural-loader" class="btn-icon btn-secondary absolute inset-0 hidden items-center justify-center">
                <div class="btn-spinner h-5 w-5 border-2 border-slate-400 border-t-transparent rounded-full"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex flex-col items-center justify-center gap-4 pt-4">
          <div id="record-controls" class="flex items-center justify-center gap-6 w-full h-28">
            <button id="upload-btn" class="btn-icon btn-secondary" title="Tải audio lên">
              <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </button>
            <div class="flex flex-col items-center justify-center">
              <button id="record-btn" class="btn-record flex items-center justify-center">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
                <span class="text hidden text-lg font-semibold">Dừng</span>
              </button>
            </div>
            <button id="listen-again-btn" disabled class="btn-icon btn-secondary" title="Nghe lại bản ghi">
              <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            </button>
          </div>
          <div id="waveform-container" class="hidden h-20 w-full card-layer-inset flex items-center justify-center p-2">
            <canvas id="waveform" class="w-full h-full"></canvas>
          </div>
        </div>
      </section>

      <div id="loader" class="text-center hidden py-4 flex flex-col items-center justify-center">
        <div class="w-full max-w-xs h-2 rounded-full overflow-hidden bg-[color:var(--input-bg)]">
          <div id="progress-bar-inner" class="h-full rounded-full bg-gradient-to-r from-sky-400 to-teal-400 transition-all duration-500"></div>
        </div>
        <p id="progress-text" class="text-text-secondary mt-4">PrAI đang lắng nghe và phân tích...</p>
        <p id="fun-fact" class="text-sm text-text-secondary/70 mt-6 italic hidden"></p>
      </div>

      <section id="analysis-results" class="hidden space-y-6">
        <div class="card-layer glass-card space-y-6 p-6">
          <h3 class="font-bold text-text-primary text-2xl text-center">Kết quả Phân tích</h3>
          <div class="score-container"><p><span id="overall-score"></span><span class="text-xl text-text-secondary">/100</span></p></div>

          <!-- TỪ: Biểu đồ âm tiết | CÂU: Ngữ điệu -->
          <div id="word-syllable-box" class="analysis-box-detailed hidden">
            <h4 class="analysis-title">Biểu đồ Âm tiết & Trọng âm</h4>
            <div class="syllable-chart-container"><div id="syllable-chart"></div></div>
            <div id="syllable-feedback" class="text-sm text-text-secondary"></div>
          </div>

          <div id="intonation-box" class="analysis-box-detailed hidden">
            <h4 class="analysis-title">Phân tích Ngữ điệu</h4>
            <div class="intonation-chart-container"><svg id="intonation-chart" width="100%" height="100%"></svg></div>
            <div id="intonation-analysis-feedback" class="text-sm text-text-secondary"></div>
          </div>

          <div class="analysis-box-detailed">
            <h4 class="analysis-title">Phân tích Âm vị</h4>
            <div id="phoneme-analysis" class="flex flex-wrap gap-2"></div>
            <p class="text-xs text-text-secondary mt-3">Chạm hoặc di chuột qua các âm vị để xem hướng dẫn.</p>
          </div>

          <div id="connected-speech-box" class="analysis-box-detailed">
            <h4 class="analysis-title">Phân tích Nối âm & Cụm tư duy</h4>
            <div id="connected-speech-analysis" class="space-y-3"></div>
          </div>
        </div>

        <div id="practice-suggestions" class="hidden card-layer glass-card">
          <h3 class="font-bold text-text-primary text-xl mb-4">Xem ví dụ thực tế</h3>
          <div id="suggestion-links" class="flex flex-col sm:flex-row gap-3 mt-2"></div>
        </div>
      </section>
    </main>

    <div id="message-box" class="fixed bottom-5 right-5 hidden p-4 rounded-xl text-sm z-50 shadow-lg glass-card"></div>
    <audio id="replay-audio" class="hidden"></audio>
    <input type="file" id="audio-upload-input" class="hidden" accept="audio/*" />

    <footer class="text-center mt-8 text-text-secondary text-sm">
      <p>© 2025 PrAI. Được tạo ra với niềm đam mê ngôn ngữ bởi Mr Bảo.</p>
    </footer>
  </div>

  <script type="module">
    // ==== THEME ====
    const themeToggle = document.getElementById('theme-toggle');
    const themeIconLight = document.getElementById('theme-icon-light');
    const themeIconDark = document.getElementById('theme-icon-dark');
    const docElement = document.documentElement;
    function applyTheme(theme){docElement.setAttribute('data-theme',theme); if(theme==='light'){themeIconDark.classList.remove('hidden');themeIconLight.classList.add('hidden')}else{themeIconLight.classList.remove('hidden');themeIconDark.classList.add('hidden')} localStorage.setItem('prai-theme',theme)}
    themeToggle.addEventListener('click',()=>applyTheme(docElement.getAttribute('data-theme')==='dark'?'light':'dark'));
    applyTheme(localStorage.getItem('prai-theme')||'light');

    // ==== ELEMENTS ====
    const textInput = document.getElementById('text-input');
    const accentSelect = document.getElementById('accent-select');
    const transcribeBtn = document.getElementById('transcribe-btn');
    const listenNaturalBtn = document.getElementById('listen-natural-btn');
    const listenClearBtn = document.getElementById('listen-clear-btn');
    const listenClearLoader = document.getElementById('listen-clear-loader');
    const listenNaturalLoader = document.getElementById('listen-natural-loader');
    const controlsSection = document.getElementById('controls-section');
    const simpleIpaText = document.getElementById('simple-ipa-text');
    const detailedIpaText = document.getElementById('detailed-ipa-text');
    const thoughtGroupDisplay = document.getElementById('thought-group-display');
    const thoughtGroupInfo = document.getElementById('thought-group-info');
    const thoughtGroupTooltip = document.getElementById('thought-group-tooltip');
    const recordBtn = document.getElementById('record-btn');
    const listenAgainBtn = document.getElementById('listen-again-btn');
    const loader = document.getElementById('loader');
    const progressText = document.getElementById('progress-text');
    const progressBarInner = document.getElementById('progress-bar-inner');
    const funFactEl = document.getElementById('fun-fact');
    const analysisResults = document.getElementById('analysis-results');
    const overallScore = document.getElementById('overall-score');
    const phonemeAnalysis = document.getElementById('phoneme-analysis');
    const connectedSpeechBox = document.getElementById('connected-speech-box');
    const intonationBox = document.getElementById('intonation-box');
    const intonationChart = document.getElementById('intonation-chart');
    const intonationFeedback = document.getElementById('intonation-analysis-feedback');
    const wordSyllableBox = document.getElementById('word-syllable-box');
    const syllableChart = document.getElementById('syllable-chart');
    const syllableFeedback = document.getElementById('syllable-feedback');
    const messageBox = document.getElementById('message-box');

    // ==== STATE ====
    let isRecording = false; let mediaRecorder; let audioChunks = []; let lastRecordingBlob = null; let standardIPA='';
    let modelPronunciationData = { text:'', accent:'', audio:null, pitchContour:[], stressedWords:[] };
    const singleWordAudioCache = new Map();
    let fetchIpaRequestID=0, analysisRequestID=0; let progressInterval; let progressTextTimeoutIds=[];

    // ==== API CONFIG (đi qua proxy an toàn) ====
    const TEXT_MODEL = 'gemini-2.5-flash-preview-05-20';
    const TTS_MODEL = 'gemini-2.5-flash-preview-tts';
    const TEXT_API_URL = '/api/proxy';
    const TTS_API_URL = '/api/proxy';

    // ==== UTILS ====
    function showMessage(message,type='info'){
      const typeClasses={info:'text-blue-300 border-accent-primary/30',success:'text-green-300 border-accent-success/30',warning:'text-yellow-300 border-accent-warning/30',error:'text-red-300 border-accent-danger/30'};
      messageBox.className=`fixed bottom-5 right-5 p-4 rounded-xl text-sm z-50 shadow-lg glass-card fade-in ${typeClasses[type]}`; messageBox.textContent=message; messageBox.classList.remove('hidden'); setTimeout(()=>messageBox.classList.add('hidden'), 3500);
    }
    function setButtonLoading(button,loaderEl,isLoading){button.disabled=isLoading; if(loaderEl){if(isLoading){button.classList.add('hidden');loaderEl.classList.remove('hidden');loaderEl.classList.add('flex')}else{button.classList.remove('hidden');loaderEl.classList.add('hidden');loaderEl.classList.remove('flex')}} else {const textEl=button.querySelector('.text'); const iconEl=button.querySelector('.icon'); const spinnerEl=button.querySelector('.btn-spinner'); if(isLoading){if(textEl)textEl.style.visibility='hidden'; if(iconEl)iconEl.style.visibility='hidden'; if(spinnerEl)spinnerEl.classList.remove('hidden')} else {if(textEl)textEl.style.visibility='visible'; if(iconEl)iconEl.style.visibility='visible'; if(spinnerEl)spinnerEl.classList.add('hidden')}} }
    function base64ToArrayBuffer(base64){const binaryString=atob(base64); const len=binaryString.length; const bytes=new Uint8Array(len); for(let i=0;i<len;i++){bytes[i]=binaryString.charCodeAt(i)} return bytes.buffer}
    function pcmToWav(pcmData,sampleRate){const numChannels=1,bitsPerSample=16; const byteRate=sampleRate*numChannels*bitsPerSample/8; const blockAlign=numChannels*bitsPerSample/8; const dataSize=pcmData.length*2; const buffer=new ArrayBuffer(44+dataSize); const view=new DataView(buffer); const w=(off,str)=>{for(let i=0;i<str.length;i++)view.setUint8(off+i,str.charCodeAt(i))}; w(0,'RIFF'); view.setUint32(4,36+dataSize,true); w(8,'WAVE'); w(12,'fmt '); view.setUint32(16,16,true); view.setUint16(20,1,true); view.setUint16(22,numChannels,true); view.setUint32(24,sampleRate,true); view.setUint32(28,byteRate,true); view.setUint16(32,blockAlign,true); view.setUint16(34,bitsPerSample,true); w(36,'data'); view.setUint32(40,dataSize,true); for(let i=0;i<pcmData.length;i++){view.setInt16(44+i*2,pcmData[i],true)} return new Blob([view],{type:'audio/wav'}) }
    async function blobToBase64(blob){return new Promise((resolve,reject)=>{const r=new FileReader(); r.onloadend=()=>resolve(r.result.split(',')[1]); r.onerror=reject; r.readAsDataURL(blob)})}
    async function createAudioFromBase64(base64Data,mimeType){const sampleRate=mimeType.match(/rate=(\d+)/)?parseInt(mimeType.match(/rate=(\d+)/)[1],10):24000; const pcmData=base64ToArrayBuffer(base64Data); const pcm16=new Int16Array(pcmData); const wavBlob=pcmToWav(pcm16,sampleRate); const audioUrl=URL.createObjectURL(wavBlob); return new Audio(audioUrl)}

    async function fetchWithBackoff(url, options, maxRetries=3){ let delay=600; for(let i=0;i<maxRetries;i++){ try{ const res=await fetch(url,options); if(res.status===429||res.status>=500){ if(i===maxRetries-1){const body=await res.json().catch(()=>({})); throw new Error(`API Error ${res.status}: ${body.error?.message||'Server error.'}`)} await new Promise(r=>setTimeout(r,delay)); delay*=1.8; continue } if(!res.ok){ const body=await res.json().catch(()=>({})); throw new Error(`API Error ${res.status}: ${body.error?.message||'Unknown error.'}`)} return await res.json(); }catch(e){ if(i===maxRetries-1) throw e; await new Promise(r=>setTimeout(r,delay)); delay*=1.8 } } }

    // ==== MODE SWITCH: TỪ đơn vs CỤM/CÂU ====
    function isSingleWord(text){const t=text.trim(); if(!t) return false; // coi -, ' là 1 từ
      return t.split(/\s+/).length===1 && !/[\s]/.test(t)}
    function updateModeUI(){const single=isSingleWord(textInput.value); // Hide/show blocks
      // Dòng phiên âm chi tiết + nút nghe tự nhiên
      detailedIpaText.parentElement.parentElement.style.opacity = single? .35 : 1;
      listenNaturalBtn.toggleAttribute('disabled', single);
      listenNaturalBtn.classList.toggle('pointer-events-none', single);
      listenNaturalBtn.classList.toggle('opacity-50', single);
      thoughtGroupDisplay.style.display = single? 'none':'block';
      thoughtGroupInfo.style.display = single? 'none':'block';
      // Phần phân tích
      connectedSpeechBox.classList.toggle('hidden', single); // Ẩn nối âm & cụm tư duy cho từ đơn
      wordSyllableBox.classList.toggle('hidden', !single);
      intonationBox.classList.toggle('hidden', single);
    }

    // ==== LOADING UI ====
    const ipaSymbols=['ə','ʃ','t','d','k','æ','iː','θ','ð','ŋ','w','j','r','l','s','z']; let ipaAnim; 
    function startIpaLoading(){stopIpaLoading(); let i=0; ipaAnim=setInterval(()=>{const seq=Array(5).fill(0).map((_,j)=>ipaSymbols[(i+j)%ipaSymbols.length]).join(' '); simpleIpaText.textContent=`/ ${seq} /`; detailedIpaText.textContent=`[ ${seq} ]`; i=(i+1)%ipaSymbols.length },100)}
    function stopIpaLoading(){clearInterval(ipaAnim)}

    // ==== PREFETCH MODEL VOICE ====
    async function prefetchModelPronunciation(text, accent){ modelPronunciationData={text,accent,audio:null,pitchContour:[],stressedWords:[]};
      try{
        // Tạo giọng mẫu (AUDIO)
        const promptTTS = `Read ONLY the following text in ${accent}. Pronounce it naturally and fluently. Text: ${text}`;
        const payloadTTS={contents:[{parts:[{text:promptTTS}]}], generationConfig:{responseModalities:['AUDIO']}, model:TTS_MODEL};
        const dataTTS = await fetchWithBackoff(TTS_API_URL,{method:'POST', headers:{'Content-Type':'application/json','X-Target-API':'tts'}, body:JSON.stringify(payloadTTS)});
        const audioPart=dataTTS?.candidates?.[0]?.content?.parts?.[0]; if(!audioPart?.inlineData) throw new Error('No TTS audio');
        const audio=await createAudioFromBase64(audioPart.inlineData.data, audioPart.inlineData.mimeType); modelPronunciationData.audio=audio;

        // Phân tích đường cong cao độ + từ nhấn từ giọng mẫu
        const promptAnalysis=`Analyze the provided audio of the sentence \'${text}\'. Return a JSON with 'pitch_contour' (40-60 normalized 0-100 points) and 'stressed_words' (array of {word, time_stamp_normalized 0..1}).`;
        const wavBlob = await (async()=>{ // chuyển audioPart -> WAV blob
          const sr = audioPart.inlineData.mimeType.match(/rate=(\d+)/)?parseInt(audioPart.inlineData.mimeType.match(/rate=(\d+)/)[1],10):24000;
          const pcm=new Int16Array(base64ToArrayBuffer(audioPart.inlineData.data));
          return pcmToWav(pcm, sr);
        })();
        const payloadAnalysis={contents:[{role:'user',parts:[{text:promptAnalysis},{inlineData:{mimeType:'audio/wav', data: await blobToBase64(wavBlob)}}]}], generationConfig:{responseMimeType:'application/json'}};
        const dataAnalysis = await fetchWithBackoff(TEXT_API_URL,{method:'POST', headers:{'Content-Type':'application/json','X-Target-API':'text'}, body:JSON.stringify(payloadAnalysis)});
        const resultJSON = JSON.parse(dataAnalysis.candidates[0].content.parts[0].text||'{}');
        modelPronunciationData.pitchContour = resultJSON.pitch_contour||[];
        modelPronunciationData.stressedWords = resultJSON.stressed_words||[];
      }catch(e){ console.warn('Prefetch model voice failed:', e.message); modelPronunciationData={text:'',accent:'',audio:null,pitchContour:[],stressedWords:[]}; }
    }

    async function prefetchSingleWordVoice(text,accent){ try{ const key=`${text}_${accent}`; if(singleWordAudioCache.has(key)) return;
      const payload={contents:[{parts:[{text:`Read ONLY the following text in ${accent}. Pronounce it clearly and naturally. Text: ${text}` }]}], generationConfig:{responseModalities:['AUDIO']}, model:TTS_MODEL};
      const data=await fetchWithBackoff(TTS_API_URL,{method:'POST',headers:{'Content-Type':'application/json','X-Target-API':'tts'}, body:JSON.stringify(payload)});
      const audioPart=data?.candidates?.[0]?.content?.parts?.[0]; if(!audioPart?.inlineData) return;
      const audio=await createAudioFromBase64(audioPart.inlineData.data, audioPart.inlineData.mimeType); singleWordAudioCache.set(key,audio); audio.play(); // auto-play 1 lần
    }catch(e){ console.info('Single-word TTS fallback (silent):', e.message) } }

    // ==== IPA FETCH ====
    const ipaCache={get:k=>{try{const i=localStorage.getItem(k);return i?JSON.parse(i):null}catch(_){return null}}, set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch(_){}}};
    async function fetchAndDisplayIPA(){ fetchIpaRequestID++; const rid=fetchIpaRequestID; const text=textInput.value.trim(); if(!text){return false}
      const accent=accentSelect.value; const cacheKey=`ipa_${text}_${accent}`; const cached=ipaCache.get(cacheKey);
      controlsSection.classList.remove('hidden'); updateModeUI();
      if(cached){ displayIpaData(cached); if(!isSingleWord(text)) prefetchModelPronunciation(text,accent); else prefetchSingleWordVoice(text,accent); return true }
      startIpaLoading(); setButtonLoading(transcribeBtn,null,true);
      try{
        const single=isSingleWord(text);
        const prompt = single
          ? `For the word "${text}" (${accent}), respond ONLY a JSON {"simple": "/.../"}.`
          : `For the phrase "${text}" (${accent}), respond ONLY this JSON: {"simple":"...","detailed":"...","thought_groups":{"groups":["..."],"explanation":"..."}}. IMPORTANT: Use linking (‿) ONLY when phonetically valid within each thought group.`;
        const payload={contents:[{parts:[{text:prompt}]}], generationConfig:{responseMimeType:'application/json'}};
        const res=await fetchWithBackoff(TEXT_API_URL,{method:'POST',headers:{'Content-Type':'application/json','X-Target-API':'text'}, body:JSON.stringify(payload)});
        if(rid!==fetchIpaRequestID) return false; const resultText=res.candidates[0].content.parts[0].text; let json=JSON.parse(resultText||'{}'); if(!json) throw new Error('Empty IPA'); if(!json.detailed) json.detailed=json.simple;
        ipaCache.set(cacheKey,json); displayIpaData(json);
        if(single){await prefetchSingleWordVoice(text,accent); await buildWordSyllables(text,accent)} else {prefetchModelPronunciation(text,accent)}
        return true;
      }catch(e){ console.error(e); showMessage('Không thể lấy phiên âm. Vui lòng thử lại.', 'error'); return false }
      finally{ if(rid===fetchIpaRequestID){ stopIpaLoading(); setButtonLoading(transcribeBtn,null,false) } }
    }

    function displayIpaData(data){ standardIPA=data.detailed; simpleIpaText.textContent=data.simple; detailedIpaText.textContent=data.detailed; if(data.thought_groups && textInput.value.trim().includes(' ')){ displayThoughtGroups(data.thought_groups.groups, data.thought_groups.explanation) } else { displayThoughtGroups([], '') } }
    function displayThoughtGroups(groups,explanation){ thoughtGroupDisplay.innerHTML=''; thoughtGroupTooltip.textContent=explanation||''; if(groups && groups.length>0 && explanation){ thoughtGroupInfo.style.display='block'; groups.forEach((g,i)=>{ const el=document.createElement('span'); el.textContent=g; el.className=`inline-block px-2 py-1 rounded-md mr-1 ${i%2? 'bg-sky-200/40':'bg-emerald-200/40'}`; thoughtGroupDisplay.appendChild(el) }) } else { thoughtGroupInfo.style.display='none' } }

    // ==== SYLLABLE CHART (từ đơn) ====
    async function buildWordSyllables(text, accent){ try{ const payload={contents:[{parts:[{text:`Give JSON for syllabification of "${text}" (${accent}). Return {"syllables":["..."],"stress_index": number (primary stress syllable index or -1 if none) } ONLY.`}]}], generationConfig:{responseMimeType:'application/json'}, model:TEXT_MODEL};
      const res=await fetchWithBackoff(TEXT_API_URL,{method:'POST',headers:{'Content-Type':'application/json','X-Target-API':'text'},body:JSON.stringify(payload)});
      const j=JSON.parse(res.candidates[0].content.parts[0].text||'{"syllables":["'+text+'"],"stress_index":-1}');
      drawSyllableChart(j.syllables||[text], j.stress_index??-1);
    }catch(_){ drawSyllableChart([text], -1) } }
    function drawSyllableChart(syllables, stressIdx){ syllableChart.innerHTML=''; syllables.forEach((s,idx)=>{ const b=document.createElement('span'); b.className='syllable-bubble'; b.textContent=s; if(idx===stressIdx){ b.classList.add('stressed') } syllableChart.appendChild(b) }); syllableFeedback.textContent = stressIdx>=0 ? `Trọng âm rơi vào âm tiết ${stressIdx+1}.` : 'Từ không có trọng âm nổi bật (ví dụ: function words).'; }

    // ==== INTONATION CHART (câu/cụm) ====
    function drawIntonationChart(){ const svg=intonationChart; while(svg.firstChild) svg.removeChild(svg.firstChild); const w=svg.clientWidth||svg.parentElement.clientWidth, h=svg.clientHeight||200; const pts=modelPronunciationData.pitchContour; if(!pts || pts.length<4) return; const pad=16; const dw=(w-2*pad)/(pts.length-1); const max=100, min=0; const pathPts=pts.map((v,i)=>`${i? 'L':'M'} ${pad+i*dw} ${pad + (1-(v-min)/(max-min))*(h-2*pad)}`).join(' '); const path=document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d', pathPts); path.setAttribute('fill','none'); path.setAttribute('stroke','currentColor'); path.setAttribute('stroke-width','2'); svg.appendChild(path);
      // tìm đỉnh cục bộ
      const peaks=[]; for(let i=1;i<pts.length-1;i++){ if(pts[i]>pts[i-1] && pts[i]>pts[i+1]) peaks.push({i, y: pad + (1-pts[i]/100)*(h-2*pad)}) }
      // đặt nhãn từ nhấn trên đỉnh -> không đè lên đường (offset lên trên)
      modelPronunciationData.stressedWords.forEach(sw=>{ const x = pad + Math.min(pts.length-1, Math.max(0, Math.round(sw.time_stamp_normalized*(pts.length-1))))*dw; const near = peaks.reduce((a,b)=> Math.abs((pad+(b.i*dw))-x) < Math.abs((pad+(a.i*dw))-x) ? b : a, peaks[0]||{i:0,y:pad+(h-2*pad)}); const label=document.createElementNS('http://www.w3.org/2000/svg','text'); label.textContent=sw.word; label.setAttribute('x', `${x}`); label.setAttribute('y', `${(near?.y||pad+20)-8}`); label.setAttribute('text-anchor','middle'); label.setAttribute('font-size','12'); svg.appendChild(label); });
    }

    // ==== LISTEN BUTTONS (chống lỗi kết nối, luôn êm) ====
    async function safeTTS({type}){ const text=textInput.value.trim(); const accent=accentSelect.value; if(!text){showMessage('Vui lòng nhập nội dung trước.', 'warning'); return}
      const single=isSingleWord(text); try{
        if(type==='natural'){
          if(single){ const key=`${text}_${accent}`; if(singleWordAudioCache.has(key)){ singleWordAudioCache.get(key).currentTime=0; singleWordAudioCache.get(key).play(); return } await prefetchSingleWordVoice(text,accent); const a=singleWordAudioCache.get(`${text}_${accent}`); if(a){a.currentTime=0; a.play()} }
          else { if(modelPronunciationData.text===text && modelPronunciationData.accent===accent && modelPronunciationData.audio){ modelPronunciationData.audio.currentTime=0; modelPronunciationData.audio.play() } else { await prefetchModelPronunciation(text,accent); if(modelPronunciationData.audio){ modelPronunciationData.audio.currentTime=0; modelPronunciationData.audio.play() } } }
        } else { // clear voice
          const prompt=`Say very clearly, with slight pause between each word, in ${accent}: ${text}`; const payload={contents:[{parts:[{text:prompt}]}], generationConfig:{responseModalities:['AUDIO']}, model:TTS_MODEL};
          const data=await fetchWithBackoff(TTS_API_URL,{method:'POST', headers:{'Content-Type':'application/json','X-Target-API':'tts'}, body:JSON.stringify(payload)});
          const part=data?.candidates?.[0]?.content?.parts?.[0]; if(part?.inlineData){ const audio=await createAudioFromBase64(part.inlineData.data, part.inlineData.mimeType); audio.play() }
        }
      }catch(_){ // Không báo lỗi gắt -> trải nghiệm êm
        showMessage('Đang chuẩn bị lại giọng mẫu...', 'info'); setTimeout(()=>{},1000)
      }
    }
    listenNaturalBtn.addEventListener('click', ()=> safeTTS({type:'natural'}));
    listenClearBtn.addEventListener('click', ()=> safeTTS({type:'clear'}));

    // ==== ANALYZE AUDIO ====
    function startProgress(){ if(!progressBarInner) return; let w=0; progressBarInner.style.width='0%'; clearInterval(progressInterval); progressInterval=setInterval(()=>{ if(w<95) w+=Math.random()*2; else clearInterval(progressInterval); progressBarInner.style.width=Math.min(w,95)+'%'; }, 100); const steps=[{t:'Okie, PrAI đã nhận được bản ghi âm của bạn...',d:1200},{t:'Đang phiên âm giọng nói của bạn!',d:1800},{t:'So sánh từng âm một với giọng chuẩn...',d:2200},{t:'Kiểm tra ngữ điệu & tốc độ...',d:1600},{t:'Xong rồi! Cùng xem kết quả nhé!',d:800}]; let acc=0; progressTextTimeoutIds.forEach(clearTimeout); progressTextTimeoutIds=[]; steps.forEach(s=>{ const id=setTimeout(()=>{progressText.textContent=s.t}, acc); progressTextTimeoutIds.push(id); acc+=s.d }) }
    function stopProgress(){ clearInterval(progressInterval); progressBarInner.style.width='100%'; progressTextTimeoutIds.forEach(clearTimeout); progressTextTimeoutIds=[] }

    async function analyzeAudio(audioBlob){ analysisRequestID++; const rid=analysisRequestID; if(!audioBlob) return; if(!standardIPA){showMessage('Không có phiên âm chuẩn để đối chiếu.', 'error'); return}
      const text=textInput.value.trim(); const accent=accentSelect.value; const single=isSingleWord(text);
      loader.classList.remove('hidden'); funFactEl.classList.add('hidden'); startProgress();
      const b64 = await blobToBase64(audioBlob);
      try{
        const basePromptSingle = {
          role: 'Bạn là chuyên gia ngữ âm tiếng Anh cho người Việt',
          schema: {
            type: 'OBJECT', properties: {
              target_text: {type:'STRING'}, recognized_text:{type:'STRING'}, same_as_target:{type:'BOOLEAN'},
              phones: { type:'ARRAY', items:{ type:'OBJECT', properties:{ target:{type:'STRING'}, user:{type:'STRING'}, status:{type:'STRING', enum:['correct','approximate','incorrect']}, note:{type:'STRING'} } } },
              score:{type:'NUMBER'}, comments:{type:'STRING'} }
          }
        };
        const basePromptSentence = {
          role: 'Bạn là chuyên gia ngữ âm tiếng Anh cho người Việt',
          schema: {
            type:'OBJECT', properties:{ recognized_text:{type:'STRING'}, same_as_target:{type:'BOOLEAN'}, phones_summary:{type:'STRING'}, prosody:{type:'OBJECT', properties:{ intonation:{type:'STRING'}, rate_wpm:{type:'NUMBER'}, remarks:{type:'STRING'} }}, score:{type:'NUMBER'}, comments:{type:'STRING'} }
          }
        };
        const payload = single ? {
          contents:[{parts:[{text:`Nhiệm vụ: Phân tích phát âm TỪ ĐƠN. Đối chiếu rất nghiêm ngặt. Nếu người dùng nói KHÁC từ mục tiêu, trả về same_as_target=false và KHÔNG chấm. Mục tiêu: "${text}". IPA chuẩn: ${standardIPA}. Hãy trả về JSON theo schema.`},{inlineData:{mimeType:'audio/wav',data:b64}}]}],
          generationConfig:{responseMimeType:'application/json', responseSchema: basePromptSingle.schema}, model:TEXT_MODEL
        } : {
          contents:[{parts:[{text:`Nhiệm vụ: Phân tích phát âm CỤM/CÂU. Linh hoạt hơn từ đơn. Khoan dung với các lỗi phổ biến của người Việt (ví dụ: glottalized [t], thay /θ/ thành /t/ nhẹ, v.v.) nhưng vẫn ghi nhận trong comments. Nếu câu nói KHÁC câu mục tiêu thì same_as_target=false và giải thích ngắn gọn, KHÔNG chấm. Văn bản mục tiêu: "${text}". IPA chuẩn: ${standardIPA}. Đường cong cao độ mẫu: ${JSON.stringify(modelPronunciationData.pitchContour)}.`},{inlineData:{mimeType:'audio/wav',data:b64}}]}],
          generationConfig:{responseMimeType:'application/json', responseSchema: basePromptSentence.schema}, model:TEXT_MODEL
        };
        const res = await fetchWithBackoff(TEXT_API_URL,{method:'POST', headers:{'Content-Type':'application/json','X-Target-API':'text'}, body:JSON.stringify(payload)});
        if(rid!==analysisRequestID) return;
        const out = JSON.parse(res.candidates[0].content.parts[0].text||'{}');

        // Kiểm tra nói khác
        if(out.same_as_target===false){ analysisResults.classList.remove('hidden'); overallScore.textContent='--'; phonemeAnalysis.innerHTML=''; connectedSpeechBox.classList.add('hidden'); intonationBox.classList.add('hidden'); wordSyllableBox.classList.add('hidden'); showMessage('Bạn đã phát âm khác nội dung mục tiêu. Hãy thu lại đúng từ/câu.', 'warning'); return }

        // Render điểm + phoneme chips
        const score = Math.max(0, Math.min(100, Math.round(out.score||0)));
        overallScore.textContent=score; const sc= document.querySelector('.score-container'); sc.classList.remove('score-low','score-medium','score-high'); sc.classList.add(score>=85?'score-high': score>=60?'score-medium':'score-low');
        phonemeAnalysis.innerHTML='';
        if(single && Array.isArray(out.phones)){
          out.phones.forEach(p=>{ const chip=document.createElement('span'); chip.className='phoneme'; chip.textContent=p.target; chip.title=(p.note||''); chip.classList.add(p.status==='correct'?'status-correct': p.status==='approximate'?'status-approximate':'status-incorrect'); phonemeAnalysis.appendChild(chip) })
        } else {
          // Tóm tắt theo cụm cho câu (giữ nhẹ nhàng)
          const tip=document.createElement('div'); tip.className='text-sm text-text-secondary'; tip.textContent = out.phones_summary || 'Âm vị ổn; xem phần nhận xét.'; phonemeAnalysis.appendChild(tip);
        }

        // Biểu đồ: từ -> âm tiết; câu -> ngữ điệu
        if(single){ wordSyllableBox.classList.remove('hidden'); intonationBox.classList.add('hidden') } else { drawIntonationChart(); intonationBox.classList.remove('hidden'); wordSyllableBox.classList.add('hidden') }

        // Connected speech chỉ cho câu
        connectedSpeechBox.classList.toggle('hidden', single);

        // Nhận xét
        const fb = single? (out.comments||'') : (out.prosody? `Ngữ điệu: ${out.prosody.intonation}. Tốc độ (ước tính): ${Math.round(out.prosody.rate_wpm||0)} wpm. ${out.prosody.remarks||''}` : (out.comments||''));
        intonationFeedback.textContent = fb;

        analysisResults.classList.remove('hidden');
      }catch(e){ console.error(e); showMessage('Không phân tích được bản ghi. Thử lại nhé.', 'error') }
      finally{ loader.classList.add('hidden'); stopProgress() }
    }

    // ==== EVENTS ====
    transcribeBtn.addEventListener('click', fetchAndDisplayIPA);
    textInput.addEventListener('input', updateModeUI);

    // Recording (giữ nguyên cách hoạt động ổn định)
    if(navigator.mediaDevices?.getUserMedia){
      recordBtn.addEventListener('click', async()=>{
        if(!isRecording){
          const stream = await navigator.mediaDevices.getUserMedia({audio:true});
          mediaRecorder = new MediaRecorder(stream);
          audioChunks=[]; mediaRecorder.ondataavailable = e=>{ if(e.data.size>0) audioChunks.push(e.data) };
          mediaRecorder.onstop = async()=>{ const blob=new Blob(audioChunks,{type:'audio/webm'}); lastRecordingBlob=blob; const arrBuf=await blob.arrayBuffer(); // convert to wav for model
            // Decode webm -> play back and analyze
            const audio = new Audio(URL.createObjectURL(blob)); audio.onended = ()=>{}; audio.play();
            // convert webm to wav via offline context
            try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const buf = await ctx.decodeAudioData(arrBuf.slice(0)); const wavBlob = await (async()=>{ const ch=1; const len=buf.length; const data=new Float32Array(len); buf.copyFromChannel(data,0,0); // 16-bit PCM
              const pcm = new Int16Array(len); for(let i=0;i<len;i++){ pcm[i]=Math.max(-1,Math.min(1,data[i]))*0x7FFF }
              return pcmToWav(pcm, buf.sampleRate) })(); await analyzeAudio(wavBlob) }catch(e){ console.warn('Decode fail -> gửi webm as-is'); await analyzeAudio(blob) }
          };
          mediaRecorder.start(); isRecording=true; recordBtn.classList.add('is-recording')
        } else { mediaRecorder.stop(); isRecording=false; recordBtn.classList.remove('is-recording') }
      })
    }
  </script>
</body>
</html>
